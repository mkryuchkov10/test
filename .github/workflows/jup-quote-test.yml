name: jup-api-test
on: workflow_dispatch
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Diagnose api.jup.ag (Ultra) and quote-api.jup.ag (v6)
        run: |
          set -euo pipefail

          echo "== Runner IP =="; curl -s https://ipinfo.io || true; echo
          sudo apt-get update -y >/dev/null
          sudo apt-get install -y dnsutils jq >/dev/null

          echo "== dig api.jup.ag =="
          echo "-- A @1.1.1.1";  dig +short api.jup.ag A @1.1.1.1 || true
          echo "-- A @8.8.8.8";  dig +short api.jup.ag A @8.8.8.8 || true
          echo "-- AAAA @1.1.1.1"; dig +short api.jup.ag AAAA @1.1.1.1 || true
          echo

          echo "== dig quote-api.jup.ag =="
          echo "-- A @1.1.1.1";  dig +short quote-api.jup.ag A @1.1.1.1 || true
          echo "-- A @8.8.8.8";  dig +short quote-api.jup.ag A @8.8.8.8 || true
          echo "-- AAAA @1.1.1.1"; dig +short quote-api.jup.ag AAAA @1.1.1.1 || true
          echo

          echo "== DoH A api.jup.ag =="
          curl -sS -H 'accept: application/dns-json' 'https://cloudflare-dns.com/dns-query?name=api.jup.ag&type=A' | tee doh_api_cf.json >/dev/null
          curl -sS 'https://dns.google/resolve?name=api.jup.ag&type=A' | tee doh_api_gg.json >/dev/null
          API_IPS=$( (jq -r '.Answer[]? | select(.type==1) | .data' doh_api_cf.json; jq -r '.Answer[]? | select(.type==1) | .data' doh_api_gg.json) | sort -u | paste -sd, -)
          echo "api.jup.ag A: ${API_IPS:-<none>}"; echo

          echo "== Probe Ultra routers =="
          ULTRA_URL='https://api.jup.ag/ultra/v1/routers'
          CODE=$(curl -sS -D hdr.ultra -w '%{http_code}' -o body.ultra "$ULTRA_URL" || true)
          echo "HTTP $CODE"; echo "--- headers ---"; cat hdr.ultra || true
          echo "--- body ---"; head -c 1000 body.ultra || true
          test "$CODE" = "200"
